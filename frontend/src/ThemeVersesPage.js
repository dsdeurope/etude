import React, { useState, useEffect } from 'react';

// Fonction pour g√©n√©rer l'URL YouVersion
const generateYouVersionUrl = (book, chapter, verse) => {
  // Mapping des noms de livres fran√ßais vers les codes YouVersion
  const bookCodes = {
    // Ancien Testament
    'Gen√®se': 'GEN', 'Exode': 'EXO', 'L√©vitique': 'LEV', 'Nombres': 'NUM', 'Deut√©ronome': 'DEU',
    'Josu√©': 'JOS', 'Juges': 'JDG', 'Ruth': 'RUT', '1 Samuel': '1SA', '2 Samuel': '2SA',
    '1 Rois': '1KI', '2 Rois': '2KI', '1 Chroniques': '1CH', '2 Chroniques': '2CH',
    'Esdras': 'EZR', 'N√©h√©mie': 'NEH', 'Esther': 'EST', 'Job': 'JOB', 'Psaume': 'PSA', 'Psaumes': 'PSA',
    'Proverbes': 'PRO', 'Eccl√©siaste': 'ECC', 'Cantique': 'SNG', '√âsa√Øe': 'ISA', 'J√©r√©mie': 'JER',
    'Lamentations': 'LAM', '√âz√©chiel': 'EZK', 'Daniel': 'DAN', 'Os√©e': 'HOS', 'Jo√´l': 'JOL',
    'Amos': 'AMO', 'Abdias': 'OBA', 'Jonas': 'JON', 'Mich√©e': 'MIC', 'Nahum': 'NAM',
    'Habacuc': 'HAB', 'Sophonie': 'ZEP', 'Agg√©e': 'HAG', 'Zacharie': 'ZEC', 'Malachie': 'MAL',
    
    // Nouveau Testament
    'Matthieu': 'MAT', 'Marc': 'MRK', 'Luc': 'LUK', 'Jean': 'JHN', 'Actes': 'ACT',
    'Romains': 'ROM', '1 Corinthiens': '1CO', '2 Corinthiens': '2CO', 'Galates': 'GAL',
    '√âph√©siens': 'EPH', 'Philippiens': 'PHP', 'Philippe': 'PHP', 'Colossiens': 'COL',
    '1 Thessaloniciens': '1TH', '2 Thessaloniciens': '2TH', '1 Timoth√©e': '1TI', '2 Timoth√©e': '2TI',
    'Tite': 'TIT', 'Phil√©mon': 'PHM', 'H√©breux': 'HEB', 'Jacques': 'JAS', '1 Pierre': '1PE',
    '2 Pierre': '2PE', '1 Jean': '1JN', '2 Jean': '2JN', '3 Jean': '3JN', 'Jude': 'JUD',
    'Apocalypse': 'REV'
  };
  
  const bookCode = bookCodes[book];
  if (!bookCode) {
    console.warn(`Code YouVersion non trouv√© pour: ${book}`);
    return `https://www.bible.com/search/bible?q=${encodeURIComponent(book + ' ' + chapter + ':' + verse)}`;
  }
  
  // URL YouVersion avec version Louis Segond (LSG = 93)
  return `https://www.bible.com/bible/93/${bookCode}.${chapter}.${verse}.LSG`;
};

const ThemeVersesPage = ({ theme, onGoBack }) => {
  const [verses, setVerses] = useState([]);
  const [isLoading, setIsLoading] = useState(true);

  // Ancienne base de donn√©es remplac√©e par API calls dynamiques

  useEffect(() => {
    loadThemeVerses();
  }, [theme]);

  const loadThemeVerses = async () => {
    setIsLoading(true);
    
    try {
      // Strat√©gie multi-recherches pour garantir 20+ versets
      const searchStrategies = getSearchStrategies(theme);
      let allVerses = [];
      
      // Effectuer plusieurs recherches pour collecter suffisamment de versets
      for (const searchTerm of searchStrategies) {
        if (allVerses.length >= 25) break; // Arr√™ter quand on a assez de versets
        
        try {
          const response = await fetch(`${process.env.REACT_APP_BACKEND_URL}/api/search-concordance`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              search_term: searchTerm,
              enrich: true
            })
          });

          if (response.ok) {
            const result = await response.json();
            
            if (result.status === 'success' && result.bible_verses) {
              const newVerses = result.bible_verses.map(verse => ({
                book: verse.book || "Livre",
                chapter: verse.chapter || 1,
                verse: verse.verse || 1,
                text: verse.text || verse.content || "Texte du verset",
                reference: `${verse.book || 'Livre'} ${verse.chapter || 1}:${verse.verse || 1}`
              }));
              
              // √âviter les doublons
              const uniqueVerses = newVerses.filter(newVerse => 
                !allVerses.some(existing => 
                  existing.reference === newVerse.reference
                )
              );
              
              allVerses = [...allVerses, ...uniqueVerses];
              console.log(`[API GEMINI] ${uniqueVerses.length} nouveaux versets pour "${searchTerm}" - Total: ${allVerses.length}`);
            }
          }
        } catch (searchError) {
          console.warn(`Erreur recherche pour "${searchTerm}":`, searchError);
        }
      }
      
      // S'assurer d'avoir au moins 20 versets
      if (allVerses.length < 20) {
        console.log(`Seulement ${allVerses.length} versets trouv√©s, ajout de versets de r√©f√©rence...`);
        const extraVerses = await getThemeReferenceVerses(theme);
        allVerses = [...allVerses, ...extraVerses].slice(0, 30);
      }
      
      // Limiter √† 30 versets maximum et garantir minimum 20
      const finalVerses = allVerses.slice(0, 30);
      
      if (finalVerses.length >= 20) {
        setVerses(finalVerses);
        console.log(`[SUCCESS] ${finalVerses.length} versets r√©cup√©r√©s pour "${theme}"`);
      } else {
        // Si encore insuffisant, utiliser le fallback √©tendu
        await loadExtendedFallbackVerses(theme);
      }
      
    } catch (error) {
      console.error("Erreur chargement versets th√®me:", error);
      await loadExtendedFallbackVerses(theme);
    } finally {
      setIsLoading(false);
    }
  };

  // Fonction pour extraire les mots-cl√©s d'un th√®me
  const extractThemeKeywords = (themeName) => {
    const themeKeywords = {
      "Amour et Charit√©": "amour charit√© aimer",
      "Foi et Confiance": "foi confiance croire",
      "Esp√©rance et Promesses": "esp√©rance promesse espoir",
      "Pardon et Mis√©ricorde": "pardon mis√©ricorde pardonner",
      "Justice et Droiture": "justice droiture juste",
      "Sagesse et Connaissance": "sagesse connaissance sage",
      "Pri√®re et Adoration": "pri√®re adoration prier",
      "Paix et R√©conciliation": "paix r√©conciliation paisible",
      "Joie et Louange": "joie louange r√©jouir",
      "Humilit√© et Service": "humilit√© service servir",
      "Courage et Force": "courage force fort",
      "Patience et Pers√©v√©rance": "patience pers√©v√©rance patient",
      "Compassion et Bont√©": "compassion bont√© compatissant",
      "V√©rit√© et Sinc√©rit√©": "v√©rit√© sinc√©rit√© vrai",
      "Libert√© et D√©livrance": "libert√© d√©livrance lib√©rer",
      "Gu√©rison et Restauration": "gu√©rison restauration gu√©rir",
      "Famille et Relations": "famille relation parent",
      "Travail et Vocation": "travail vocation ≈ìuvre",
      "Richesse et Pauvret√©": "richesse pauvret√© riche pauvre",
      "Souffrance et √âpreuves": "souffrance √©preuve souffrir",
      "Mort et R√©surrection": "mort r√©surrection mourir ressusciter",
      "Cr√©ation et Nature": "cr√©ation nature cr√©er",
      "Proph√©tie et R√©v√©lation": "proph√©tie r√©v√©lation proph√®te",
      "Royaume de Dieu": "royaume ciel c√©leste",
      "Salut et R√©demption": "salut r√©demption sauver",
      "Saint-Esprit": "esprit saint consolateur",
      "√âglise et Communaut√©": "√©glise communaut√© assembl√©e",
      "Mission et √âvang√©lisation": "mission √©vang√©lisation √©vangile",
      "Sanctification": "sanctification saint sanctifier",
      "Eschatologie et Fin des Temps": "eschatologie fin temps dernier jour"
    };
    
    return themeKeywords[themeName] || themeName.replace(/\set\s/g, ' ').toLowerCase();
  };

  // Fallback vers quelques versets de base si l'API √©choue
  const loadFallbackVerses = async (themeName) => {
    const fallbackVerses = [
      { 
        book: "1 Jean", 
        chapter: 4, 
        verse: 8, 
        text: "Celui qui n'aime pas n'a pas connu Dieu, car Dieu est amour." 
      },
      { 
        book: "Jean", 
        chapter: 3, 
        verse: 16, 
        text: "Car Dieu a tant aim√© le monde qu'il a donn√© son Fils unique, afin que quiconque croit en lui ne p√©risse point, mais qu'il ait la vie √©ternelle." 
      },
      { 
        book: "1 Corinthiens", 
        chapter: 13, 
        verse: 4, 
        text: "L'amour est patient, l'amour est plein de bont√©; l'amour n'est point envieux; l'amour ne se vante point, il ne s'enfle point d'orgueil." 
      }
    ];
    
    setVerses(fallbackVerses);
    console.log(`[FALLBACK] Utilisation de ${fallbackVerses.length} versets de base pour "${themeName}"`);
  };

  if (isLoading) {
    return (
      <div style={{ 
        minHeight: '100vh', 
        background: 'linear-gradient(135deg, #f8fafc 0%, #ffffff 100%)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center'
      }}>
        <div style={{ textAlign: 'center', color: '#667eea' }}>
          <div style={{ 
            fontSize: '48px', 
            marginBottom: '20px',
            animation: 'spin 2s linear infinite'
          }}>üìñ</div>
          <h2>Recherche des versets sur "{theme}"...</h2>
          <p>Compilation de plus de 20 versets bibliques</p>
        </div>
      </div>
    );
  }

  return (
    <div style={{ 
      minHeight: '100vh', 
      background: 'linear-gradient(135deg, #f8fafc 0%, #ffffff 100%)',
      padding: '20px'
    }}>
      {/* Header avec retour */}
      <div style={{
        display: 'flex',
        alignItems: 'center',
        gap: '20px',
        marginBottom: '30px',
        maxWidth: '1200px',
        margin: '0 auto 30px auto'
      }}>
        <button 
          onClick={onGoBack}
          style={{
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            color: 'white',
            border: 'none',
            borderRadius: '12px',
            padding: '12px 24px',
            fontSize: '14px',
            fontWeight: '700',
            cursor: 'pointer',
            transition: 'all 0.3s ease',
            display: 'flex',
            alignItems: 'center',
            gap: '8px'
          }}
        >
          ‚Üê Retour
        </button>
        
        <div>
          <h1 style={{ 
            fontSize: '32px', 
            fontWeight: '700',
            margin: '0',
            color: '#2c3e50',
            fontFamily: "'Montserrat', sans-serif"
          }}>
            üìñ Versets sur "{theme}"
          </h1>
          <p style={{ 
            margin: '5px 0 0 0',
            color: '#667eea',
            fontSize: '16px'
          }}>
            {verses.length} versets trouv√©s ‚Ä¢ üìñ Cliquez sur les r√©f√©rences pour lire sur YouVersion
          </p>
        </div>
      </div>

      {/* Liste des versets */}
      <div style={{
        maxWidth: '1200px',
        margin: '0 auto'
      }}>
        {verses.length > 0 ? (
          <div style={{
            display: 'grid',
            gap: '20px'
          }}>
            {verses.map((verse, index) => (
              <div
                key={index}
                style={{
                  background: 'rgba(255, 255, 255, 0.8)',
                  backdropFilter: 'blur(20px)',
                  borderRadius: '16px',
                  padding: '24px',
                  border: '1px solid rgba(102, 126, 234, 0.1)',
                  boxShadow: '0 8px 32px rgba(102, 126, 234, 0.1)',
                  transition: 'all 0.3s ease',
                  cursor: 'pointer'
                }}
                onMouseEnter={(e) => {
                  e.target.style.transform = 'translateY(-2px)';
                  e.target.style.boxShadow = '0 12px 48px rgba(102, 126, 234, 0.15)';
                }}
                onMouseLeave={(e) => {
                  e.target.style.transform = 'translateY(0)';
                  e.target.style.boxShadow = '0 8px 32px rgba(102, 126, 234, 0.1)';
                }}
              >
                <div style={{
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'flex-start',
                  gap: '20px'
                }}>
                  <div style={{ flex: 1 }}>
                    <p style={{
                      fontSize: '18px',
                      lineHeight: '1.6',
                      color: '#2c3e50',
                      margin: '0 0 12px 0',
                      fontFamily: "'Georgia', serif"
                    }}>
                      "{verse.text}"
                    </p>
                    <div style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: '12px'
                    }}>
                      <a 
                        href={generateYouVersionUrl(verse.book, verse.chapter, verse.verse)}
                        target="_blank"
                        rel="noopener noreferrer"
                        style={{
                          fontSize: '14px',
                          fontWeight: '700',
                          color: '#667eea',
                          textTransform: 'uppercase',
                          letterSpacing: '0.5px',
                          fontFamily: "'Montserrat', sans-serif",
                          textDecoration: 'none',
                          padding: '6px 12px',
                          background: 'linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1))',
                          borderRadius: '8px',
                          border: '1px solid rgba(102, 126, 234, 0.2)',
                          transition: 'all 0.3s ease',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '6px'
                        }}
                        onMouseEnter={(e) => {
                          e.target.style.background = 'linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2))';
                          e.target.style.transform = 'translateY(-1px)';
                          e.target.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.3)';
                        }}
                        onMouseLeave={(e) => {
                          e.target.style.background = 'linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1))';
                          e.target.style.transform = 'translateY(0)';
                          e.target.style.boxShadow = 'none';
                        }}
                      >
                        üìñ {verse.book} {verse.chapter}:{verse.verse}
                        <span style={{ fontSize: '10px', opacity: 0.7 }}>YouVersion</span>
                      </a>
                    </div>
                  </div>
                  <div style={{
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    color: 'white',
                    borderRadius: '20px',
                    padding: '6px 12px',
                    fontSize: '12px',
                    fontWeight: '600',
                    minWidth: '40px',
                    textAlign: 'center'
                  }}>
                    {index + 1}
                  </div>
                </div>
              </div>
            ))}
          </div>
        ) : (
          <div style={{
            textAlign: 'center',
            padding: '60px 20px',
            color: '#667eea'
          }}>
            <div style={{ fontSize: '48px', marginBottom: '20px' }}>üìö</div>
            <h3>Aucun verset trouv√© pour "{theme}"</h3>
            <p>Ce th√®me n'est pas encore disponible dans notre base de donn√©es.</p>
          </div>
        )}
      </div>

      <style jsx>{`
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
      `}</style>
    </div>
  );
};

export default ThemeVersesPage;