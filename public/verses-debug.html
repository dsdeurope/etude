<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Verses Debug</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: ui-sans-serif, system-ui, Arial; margin: 20px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
    input, select, button { padding: 8px 10px; border: 1px solid #ddd; border-radius: 8px; }
    button { cursor: pointer; }
    .ok { color: #059669; font-weight: 700; }
    .warn { color: #b45309; font-weight: 700; }
    .err { color: #dc2626; font-weight: 700; }
    pre { white-space: pre-wrap; background: #f8fafc; border: 1px solid #e5e7eb; padding: 12px; border-radius: 8px; max-height: 50vh; overflow: auto; }
    .small { color:#64748b; font-size: 12px; }
  </style>
</head>
<body>
  <h1>ðŸ”Ž Debug Ã‰tude Â« Verset par verset Â»</h1>

  <div class="row">
    <label>Passage&nbsp;
      <input id="passage" size="30" value="GenÃ¨se 13 LSG">
    </label>
    <button id="btnChap">Tester CHAPITRE</button>
    <button id="btnVerse">Tester VERSET unique</button>
  </div>

  <div class="row">
    <label>Endpoint&nbsp;
      <input id="endpoint" size="70" value="https://etude8-bible-api-production.up.railway.app/api/generate-verse-by-verse">
    </label>
    <button id="go">Appeler l'API</button>
  </div>

  <div id="res"></div>

  <script>
    const $ = sel => document.querySelector(sel);
    const res = $('#res');

    function analyze(text) {
      const t = String(text || '');
      const count = (pat) => (t.match(pat) || []).length;
      const stats = {
        length: t.length,
        verses: count(/VERSET\s+\d+/g),
        textes: count(/TEXTE BIBLIQUE\s*:/g),
        explications: count(/EXPLICATION THÃ‰OLOGIQUE\s*:/g),
        preview: t.slice(0, 1200)
      };
      return stats;
    }

    async function callAPI(passage) {
      const url = $('#endpoint').value.trim();
      res.innerHTML = '<p class="small">Appel en cours...</p>';
      try {
        const r = await fetch(url, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ passage, version: 'LSG' })
        });
        const data = await r.json().catch(async () => ({ content: await r.text() }));
        const content = data && data.content !== undefined ? data.content : String(data || '');
        const st = analyze(content);

        const cls = st.verses > 10 ? 'ok' : (st.verses > 1 ? 'warn' : 'err');
        res.innerHTML = `
          <p>Longueur: <b>${st.length}</b> chars â€“ VERSETS: <b class="${cls}">${st.verses}</b> â€“ TEXTE: <b>${st.textes}</b> â€“ EXPL.: <b>${st.explications}</b></p>
          <pre>${st.preview}</pre>
          <p class="small">Astuce : si VERSETS vaut 1, tu as probablement demandÃ© un <b>verset unique</b> (ex: "GenÃ¨se 13:4"). Si tu veux le chapitre entier, utilise "GenÃ¨se 13".</p>
        `;
      } catch (e) {
        res.innerHTML = `<p class="err">Erreur d'appel: ${e.message || e}</p>`;
      }
    }

    $('#go').onclick = () => callAPI($('#passage').value.trim() || 'GenÃ¨se 13 LSG');
    $('#btnChap').onclick = () => { $('#passage').value = 'GenÃ¨se 13 LSG'; callAPI($('#passage').value); };
    $('#btnVerse').onclick = () => { $('#passage').value = 'GenÃ¨se 13:4 LSG'; callAPI($('#passage').value); };
  </script>
</body>
</html>
